<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HaRi√© - Admin Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body.loading {
        opacity: 0.6;
        pointer-events: none;
      }
      .product-image-preview {
        max-width: 80px;
        max-height: 80px;
        object-fit: cover;
      }
      .out-of-stock {
        opacity: 0.6;
      }
      .featured-badge {
        background: #ffc107;
      }
    </style>
  </head>

  <body class="bg-light">
    <div class="container-fluid py-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">üõçÔ∏è HaRi√© Product Manager</h1>
        <div>
          <button class="btn btn-success me-2" onclick="saveToGitHub()">
            üíæ Save to GitHub
          </button>
          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#addProductModal"
            onclick="openAddModal()"
          >
            + Add Product
          </button>
        </div>
      </div>

      <!-- Status alert -->
      <div id="statusAlert" class="alert alert-info d-none" role="alert"></div>

      <!-- Product Table -->
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Image</th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Price</th>
                  <th>Stock</th>
                  <th>Featured</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="productsTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Product</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="productForm">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Product Name *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="productName"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Category *</label>
                    <select class="form-control" id="productCategory" required>
                      <option value="men">Men</option>
                      <option value="women">Women</option>
                      <option value="bags">Bags</option>
                      <option value="shoes">Shoes</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Price (UGX) *</label>
                    <input
                      type="number"
                      class="form-control"
                      id="productPrice"
                      required
                      min="0"
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Discount %</label>
                    <input
                      type="number"
                      class="form-control"
                      id="productDiscount"
                      min="0"
                      max="100"
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Image URL</label>
                    <input
                      type="url"
                      class="form-control"
                      id="productImage"
                      placeholder="https://..."
                    />
                    <small class="text-muted">We'll add uploads later.</small>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Badge Label</label>
                    <input
                      type="text"
                      class="form-control"
                      id="productBadge"
                      placeholder="e.g., New Arrival"
                    />
                  </div>
                  <div class="row">
                    <div class="col-6">
                      <div class="form-check mb-3">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="productFeatured"
                        />
                        <label class="form-check-label">Featured</label>
                      </div>
                    </div>
                    <div class="col-6">
                      <div class="form-check mb-3">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="productInStock"
                          checked
                        />
                        <label class="form-check-label">In Stock</label>
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea
                      class="form-control"
                      id="productDescription"
                      rows="3"
                    ></textarea>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="addProduct()"
            >
              Save Product
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const PRODUCTS_FILE = "data/products.json";
      let products = [];
      let currentProducts = [];
      let editId = null;

      document.addEventListener("DOMContentLoaded", loadProducts);

      async function loadProducts() {
        try {
          showStatus("Loading products...", "info");
          const res = await fetch(PRODUCTS_FILE + "?t=" + Date.now());
          const data = await res.json();
          products = data.products || [];
          currentProducts = [...products];
          displayProducts(products);
          showStatus("‚úÖ Products loaded", "success");
        } catch (err) {
          console.error(err);
          showStatus("‚ùå Failed to load products", "danger");
        }
      }

      function displayProducts(arr) {
        const table = document.getElementById("productsTable");
        if (arr.length === 0) {
          table.innerHTML =
            '<tr><td colspan="7" class="text-center text-muted">No products yet</td></tr>';
          return;
        }
        table.innerHTML = arr
          .map(
            (p) => `
            <tr class="${p.in_stock === false ? "out-of-stock" : ""}">
              <td>${
                p.image
                  ? `<img src="${p.image}" class="product-image-preview rounded">`
                  : "-"
              }</td>
              <td><strong>${p.name}</strong> ${
              p.badge
                ? `<span class="badge bg-info ms-1">${p.badge}</span>`
                : ""
            }</td>
              <td><span class="badge bg-secondary">${p.category}</span></td>
              <td>
                UGX ${p.price.toLocaleString()} ${
              p.discount
                ? `<br><small class="text-success">${p.discount}% off</small>`
                : ""
            }
              </td>
              <td>
                <span class="badge ${
                  p.in_stock === false ? "bg-danger" : "bg-success"
                }">${p.in_stock === false ? "Out of Stock" : "In Stock"}</span>
              </td>
              <td>${
                p.featured ? '<span class="badge featured-badge">‚≠ê</span>' : ""
              }</td>
              <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editProduct('${
                  p.id
                }')">Edit</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${
                  p.id
                }')">Delete</button>
              </td>
            </tr>`
          )
          .join("");
      }

      function openAddModal() {
        editId = null;
        document.querySelector("#addProductModal .modal-title").textContent =
          "Add Product";
        document.getElementById("productForm").reset();
        document.getElementById("productInStock").checked = true;
        document.getElementById("productFeatured").checked = false;
      }

      function addProduct() {
        const product = {
          id: editId || Date.now().toString(),
          name: document.getElementById("productName").value.trim(),
          category: document.getElementById("productCategory").value,
          price: parseInt(document.getElementById("productPrice").value, 10),
          description: document
            .getElementById("productDescription")
            .value.trim(),
          image:
            document.getElementById("productImage").value ||
            "/assets/img/placeholder.jpg",
          featured: document.getElementById("productFeatured").checked,
          in_stock: document.getElementById("productInStock").checked,
          discount: document.getElementById("productDiscount").value
            ? parseInt(document.getElementById("productDiscount").value, 10)
            : null,
          badge: document.getElementById("productBadge").value.trim() || null,
        };

        if (!product.name || isNaN(product.price)) {
          showStatus("Please enter valid name and price.", "warning");
          return;
        }

        if (editId) {
          const i = products.findIndex((p) => p.id === editId);
          if (i !== -1) products[i] = product;
          showStatus(`Product "${product.name}" updated locally.`, "warning");
        } else {
          products.push(product);
          showStatus(`Product "${product.name}" added locally.`, "warning");
        }

        displayProducts(products);
        bootstrap.Modal.getInstance(
          document.getElementById("addProductModal")
        ).hide();
        document.getElementById("productForm").reset();
        editId = null;
      }

      function editProduct(id) {
        const p = products.find((x) => x.id === id);
        if (!p) return;

        editId = p.id;
        document.querySelector("#addProductModal .modal-title").textContent =
          "Edit Product";
        document.getElementById("productName").value = p.name || "";
        document.getElementById("productCategory").value = p.category || "men";
        document.getElementById("productPrice").value = p.price ?? 0;
        document.getElementById("productDiscount").value = p.discount ?? "";
        document.getElementById("productImage").value =
          p.image && p.image !== "/assets/img/placeholder.jpg" ? p.image : "";
        document.getElementById("productBadge").value = p.badge ?? "";
        document.getElementById("productFeatured").checked = !!p.featured;
        document.getElementById("productInStock").checked =
          p.in_stock !== false;
        document.getElementById("productDescription").value =
          p.description || "";

        const modalEl = document.getElementById("addProductModal");
        bootstrap.Modal.getOrCreateInstance(modalEl).show();
      }

      function deleteProduct(id) {
        if (confirm("Delete this product?")) {
          products = products.filter((p) => p.id !== id);
          displayProducts(products);
          showStatus("Product deleted locally.", "warning");
        }
      }

      async function saveToGitHub() {
        try {
          showStatus("Saving via Cloudflare Function...", "info");
          document.body.classList.add("loading");

          const res = await fetch("/save-products", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ products }),
          });

          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Unknown error");

          currentProducts = [...products];
          showStatus("‚úÖ Products saved successfully!", "success");
        } catch (err) {
          console.error(err);
          showStatus("‚ùå Save failed: " + err.message, "danger");
        } finally {
          document.body.classList.remove("loading");
        }
      }

      function showStatus(message, type) {
        const alert = document.getElementById("statusAlert");
        alert.textContent = message;
        alert.className = `alert alert-${type}`;
        alert.classList.remove("d-none");
        setTimeout(() => alert.classList.add("d-none"), 5000);
      }
    </script>
  </body>
</html>
