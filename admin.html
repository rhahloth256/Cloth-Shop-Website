<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HaRi√© - Admin Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .product-image-preview {
        max-width: 100px;
        max-height: 100px;
        object-fit: cover;
      }
      .out-of-stock {
        opacity: 0.6;
      }
      .featured-badge {
        background: #ffc107;
      }
      .loading {
        opacity: 0.6;
        pointer-events: none;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container-fluid py-4">
      <div class="row">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">üõçÔ∏è HaRi√© Product Manager</h1>
            <div>
              <button class="btn btn-success me-2" onclick="saveToGitHub()">
                üíæ Save to GitHub
              </button>
              <button
                class="btn btn-primary"
                data-bs-toggle="modal"
                data-bs-target="#addProductModal"
              >
                + Add Product
              </button>
            </div>
          </div>

          <!-- Status Alert -->
          <div
            id="statusAlert"
            class="alert alert-info d-none"
            role="alert"
          ></div>

          <!-- Products Table -->
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Image</th>
                      <th>Name</th>
                      <th>Category</th>
                      <th>Price</th>
                      <th>Stock</th>
                      <th>Featured</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="productsTable">
                    <!-- Products will be loaded here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add New Product</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="productForm">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Product Name *</label>
                    <input
                      type="text"
                      class="form-control"
                      id="productName"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Category *</label>
                    <select class="form-control" id="productCategory" required>
                      <option value="men">Men</option>
                      <option value="women">Women</option>
                      <option value="bags">Bags</option>
                      <option value="shoes">Shoes</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Price (UGX) *</label>
                    <input
                      type="number"
                      class="form-control"
                      id="productPrice"
                      required
                      min="0"
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Discount %</label>
                    <input
                      type="number"
                      class="form-control"
                      id="productDiscount"
                      min="0"
                      max="100"
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">Image URL</label>
                    <input
                      type="url"
                      class="form-control"
                      id="productImage"
                      placeholder="https://..."
                    />
                    <small class="text-muted"
                      >We'll add image upload later</small
                    >
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Badge Label</label>
                    <input
                      type="text"
                      class="form-control"
                      id="productBadge"
                      placeholder="e.g., New Arrival"
                    />
                  </div>
                  <div class="row">
                    <div class="col-6">
                      <div class="form-check mb-3">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="productFeatured"
                        />
                        <label class="form-check-label">Featured Product</label>
                      </div>
                    </div>
                    <div class="col-6">
                      <div class="form-check mb-3">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="productInStock"
                          checked
                        />
                        <label class="form-check-label">In Stock</label>
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea
                      class="form-control"
                      id="productDescription"
                      rows="3"
                    ></textarea>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="addProduct()"
            >
              Add Product
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Configuration - will be set from environment variables
      const GITHUB_USERNAME = "rhahloth256";
      const GITHUB_REPO = "Cloth-Shop-Website";
      const GITHUB_TOKEN = "{{env.GITHUB_TOKEN}}"; // Will be replaced during build
      const PRODUCTS_FILE = "data/products.json";

      let products = [];
      let currentProducts = [];

      // Load products when page opens
      document.addEventListener("DOMContentLoaded", loadProducts);

      async function loadProducts() {
        try {
          showStatus("Loading products...", "info");
          const response = await fetch(PRODUCTS_FILE + "?t=" + Date.now());
          const data = await response.json();
          products = data.products || [];
          currentProducts = [...products];
          displayProducts(products);
          showStatus("Products loaded successfully!", "success");
        } catch (error) {
          console.error("Error loading products:", error);
          showStatus("Error loading products", "danger");
        }
      }

      function displayProducts(productsArray) {
        const table = document.getElementById("productsTable");

        if (productsArray.length === 0) {
          table.innerHTML =
            '<tr><td colspan="7" class="text-center text-muted">No products yet</td></tr>';
          return;
        }

        table.innerHTML = productsArray
          .map(
            (product) => `
                <tr class="${product.in_stock === false ? "out-of-stock" : ""}">
                    <td>
                        ${
                          product.image
                            ? `<img src="${product.image}" class="product-image-preview rounded" alt="${product.name}">`
                            : '<span class="text-muted">No image</span>'
                        }
                    </td>
                    <td>
                        <strong>${product.name}</strong>
                        ${
                          product.badge
                            ? `<span class="badge bg-info ms-1">${product.badge}</span>`
                            : ""
                        }
                    </td>
                    <td><span class="badge bg-secondary">${
                      product.category
                    }</span></td>
                    <td>
                        UGX ${product.price.toLocaleString()}
                        ${
                          product.discount
                            ? `<br><small class="text-success">${product.discount}% off</small>`
                            : ""
                        }
                    </td>
                    <td>
                        <span class="badge ${
                          product.in_stock === false
                            ? "bg-danger"
                            : "bg-success"
                        }">
                            ${
                              product.in_stock === false
                                ? "Out of Stock"
                                : "In Stock"
                            }
                        </span>
                    </td>
                    <td>
                        ${
                          product.featured
                            ? '<span class="badge featured-badge">‚≠ê Featured</span>'
                            : ""
                        }
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editProduct('${
                          product.id
                        }')">Edit</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${
                          product.id
                        }')">Delete</button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      function addProduct() {
        const product = {
          id: Date.now().toString(),
          name: document.getElementById("productName").value,
          category: document.getElementById("productCategory").value,
          price: parseInt(document.getElementById("productPrice").value),
          description: document.getElementById("productDescription").value,
          image:
            document.getElementById("productImage").value ||
            "/assets/img/placeholder.jpg",
          featured: document.getElementById("productFeatured").checked,
          in_stock: document.getElementById("productInStock").checked,
          has_promo: document.getElementById("productDiscount").value > 0,
          discount: document.getElementById("productDiscount").value
            ? parseInt(document.getElementById("productDiscount").value)
            : null,
          badge: document.getElementById("productBadge").value || null,
        };

        products.push(product);
        displayProducts(products);

        // Close modal and reset form
        bootstrap.Modal.getInstance(
          document.getElementById("addProductModal")
        ).hide();
        document.getElementById("productForm").reset();

        showStatus(
          `Product "${product.name}" added locally. Click "Save to GitHub" to publish.`,
          "warning"
        );
      }

      async function saveToGitHub() {
        if (!GITHUB_TOKEN || GITHUB_TOKEN === "{{env.GITHUB_TOKEN}}") {
          showStatus(
            "GitHub token not configured. Please set GITHUB_TOKEN environment variable.",
            "danger"
          );
          return;
        }

        try {
          showStatus("Saving to GitHub...", "info");
          document.body.classList.add("loading");

          // Get current file SHA (needed for update)
          const fileInfo = await fetch(
            `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${PRODUCTS_FILE}`,
            {
              headers: {
                Authorization: `token ${GITHUB_TOKEN}`,
                Accept: "application/vnd.github.v3+json",
              },
            }
          );

          const fileData = await fileInfo.json();
          const sha = fileData.sha;

          // Update file
          const content = {
            products: products,
          };

          const updateResponse = await fetch(
            `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${PRODUCTS_FILE}`,
            {
              method: "PUT",
              headers: {
                Authorization: `token ${GITHUB_TOKEN}`,
                "Content-Type": "application/json",
                Accept: "application/vnd.github.v3+json",
              },
              body: JSON.stringify({
                message: `Update products: ${new Date().toLocaleString()}`,
                content: btoa(JSON.stringify(content, null, 2)),
                sha: sha,
              }),
            }
          );

          if (updateResponse.ok) {
            showStatus(
              "‚úÖ Products saved to GitHub successfully! Your site will update automatically.",
              "success"
            );
            currentProducts = [...products];
          } else {
            throw new Error("GitHub API error");
          }
        } catch (error) {
          console.error("Error saving to GitHub:", error);
          showStatus(
            "‚ùå Error saving to GitHub. Check console for details.",
            "danger"
          );
        } finally {
          document.body.classList.remove("loading");
        }
      }

      function showStatus(message, type) {
        const alert = document.getElementById("statusAlert");
        alert.textContent = message;
        alert.className = `alert alert-${type}`;
        alert.classList.remove("d-none");

        setTimeout(() => {
          alert.classList.add("d-none");
        }, 5000);
      }

      function editProduct(productId) {
        alert("Edit functionality coming in next update!");
      }

      function deleteProduct(productId) {
        if (confirm("Are you sure you want to delete this product?")) {
          products = products.filter((p) => p.id !== productId);
          displayProducts(products);
          showStatus(
            'Product deleted locally. Click "Save to GitHub" to publish changes.',
            "warning"
          );
        }
      }
    </script>
  </body>
</html>
